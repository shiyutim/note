# 高性能网站建设指南

[toc]

## 第一章(减少HTTP 请求)
### 图片地图
也就是将多个图片合并为一个图片，这样就可以将多个 http 请求合并为一个 http 请求。
### 精灵图
也就是将多幅图片合并为一幅图片，然后使用 css 的 `background-position` 属性图片显示出来。
### 内联图片
也就是类似于 base64 的图片格式，将图片 URL 嵌入 html 中，这样同样可以减少 http 请求。因为内联在页面中，所以**图片不会被缓存**。
### 合并脚本和样式表
如果遵循模块化的原则，将代码分开到多个小文件中，会降低性能，因为每个文件都会导致一次 http 请求。

在合理的情况下，应该尽可能的合并脚本和样式表。

## 第二章(使用内容发布网络 CDN)
1. 如果应用程序 web 服务器离用户更近，则一个 http 请求的响应时间将缩短。如果要下载的文件里用户更近，则多个 http 请求的响应时间将缩短。
2. CDN 是一组分布在多个不同地理位置的 web 服务器，用于更加有效地向用户发布内容。
3. CDN 可以缩短响应时间，可以对文件进行缓存等。

## 第三章(添加 Expires 头)
1. 在 HTTP1.1 中引入了 `Cache-control` 头来克服 `Expires` 头的限制。
2. http 请求中，如果添加 `expires` 头，指定一个时间段，那么在这个时间段之前，都可以使用缓存，不会再重新请求。
3. `Cache-control` 使用 `max-age` 指令一个请求**可以被缓存多久**。如果一个新的请求在这个时间之内，那么浏览器就会使用缓存的版本，从硬盘中读取其中的内容。
4. HTML 文档不应该使用长久的 Expires 头，因为它包含动态内容，这些内容在每次用户请求都将被更新。
5. 不仅仅可以缓存图片，还可以缓存样式表和脚本。
6. 在指定了缓存的请求头时，在指定时间内，如果想要用户获得更新，可以在文件的末尾添加版本号（时间戳），以使用户获得更新。

## 第四章(压缩组件)
1. 从 http1.1 开始，可以通过 http 请求头中的 `Accept-Encoding` 头来表示对压缩的支持。`Accept-Encoding: gzip deflate`
2. web 服务器看到请求中有这个头，就会使用客户端列出来的方法中的一种来压缩响应。`Content-Encoding: gzip`
3. 可以压缩 html 文档，脚本和样式表，但是图片和 pdf 不应该压缩，因为他们本身已经就被压缩了，试图对他们进行压缩只会浪费 cpu 资源，还有可能会增加文件大小。
4. 压缩的成本有：服务器会花费额外的 cpu 周期来完成压缩，客户端要对压缩文件进行解压。要检测收益是否大于开销，需要考虑响应的大小、连接的带宽和客户端与服务器之间的距离。
5. `Cache-Conctrol: private` 表示为所有浏览器禁用代理缓存，但这会增加带宽开销，因为代理无法缓存你的内容。

## 第五章(将样式表放在顶部)
1. 将样式表放在文档的底部，会阻止内容呈现，导致白屏。
2. 正确的做法应该是将样式表放在 head 标签内。
3. 图片是不阻止内容呈现的。

## 第六章(将脚本放在底部)
1. 根据 Http 1.1 的规范，在同一主机下浏览器默认可并行下载 2 个文件，也就是说，存在多个主机就可以增加并行下载的文件。
2. 并行下载的优劣势取决于带宽和 CPU 速度，过多的并行下载反而会影响性能。
3. JavaScript 文件是阻塞渲染的，在下载完文件之前，其他文件都不会下载。