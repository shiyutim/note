# 高性能网站建设指南

[toc]

## 第一章(减少HTTP 请求)
### 图片地图
也就是将多个图片合并为一个图片，这样就可以将多个 http 请求合并为一个 http 请求。
### 精灵图
也就是将多幅图片合并为一幅图片，然后使用 css 的 `background-position` 属性图片显示出来。
### 内联图片
也就是类似于 base64 的图片格式，将图片 URL 嵌入 html 中，这样同样可以减少 http 请求。因为内联在页面中，所以**图片不会被缓存**。
### 合并脚本和样式表
如果遵循模块化的原则，将代码分开到多个小文件中，会降低性能，因为每个文件都会导致一次 http 请求。

在合理的情况下，应该尽可能的合并脚本和样式表。

## 第二章(使用内容发布网络 CDN)
1. 如果应用程序 web 服务器离用户更近，则一个 http 请求的响应时间将缩短。如果要下载的文件里用户更近，则多个 http 请求的响应时间将缩短。
2. CDN 是一组分布在多个不同地理位置的 web 服务器，用于更加有效地向用户发布内容。
3. CDN 可以缩短响应时间，可以对文件进行缓存等。

## 第三章(添加 Expires 头)
1. 在 HTTP1.1 中引入了 `Cache-control` 头来克服 `Expires` 头的限制。
2. http 请求中，如果添加 `expires` 头，指定一个时间段，那么在这个时间段之前，都可以使用缓存，不会再重新请求。
3. `Cache-control` 使用 `max-age` 指令一个请求**可以被缓存多久**。如果一个新的请求在这个时间之内，那么浏览器就会使用缓存的版本，从硬盘中读取其中的内容。
4. HTML 文档不应该使用长久的 Expires 头，因为它包含动态内容，这些内容在每次用户请求都将被更新。
5. 不仅仅可以缓存图片，还可以缓存样式表和脚本。
6. 在指定了缓存的请求头时，在指定时间内，如果想要用户获得更新，可以在文件的末尾添加版本号（时间戳），以使用户获得更新。

## 第四章(压缩组件)
1. 从 http1.1 开始，可以通过 http 请求头中的 `Accept-Encoding` 头来表示对压缩的支持。`Accept-Encoding: gzip deflate`
2. web 服务器看到请求中有这个头，就会使用客户端列出来的方法中的一种来压缩响应。`Content-Encoding: gzip`
3. 可以压缩 html 文档，脚本和样式表，但是图片和 pdf 不应该压缩，因为他们本身已经就被压缩了，试图对他们进行压缩只会浪费 cpu 资源，还有可能会增加文件大小。
4. 压缩的成本有：服务器会花费额外的 cpu 周期来完成压缩，客户端要对压缩文件进行解压。要检测收益是否大于开销，需要考虑响应的大小、连接的带宽和客户端与服务器之间的距离。
5. `Cache-Conctrol: private` 表示为所有浏览器禁用代理缓存，但这会增加带宽开销，因为代理无法缓存你的内容。

## 第五章(将样式表放在顶部)
1. 将样式表放在文档的底部，会阻止内容呈现，导致白屏。
2. 正确的做法应该是将样式表放在 head 标签内。
3. 图片是不阻止内容呈现的。

## 第六章(将脚本放在底部)
1. 根据 Http 1.1 的规范，在同一主机下浏览器默认可并行下载 2 个文件，也就是说，存在多个主机就可以增加并行下载的文件。
2. 并行下载的优劣势取决于带宽和 CPU 速度，过多的并行下载反而会影响性能。
3. JavaScript 文件是阻塞渲染的，在下载完文件之前，其他文件都不会下载。

## 第七章(避免 CSS 表达式)
1. 避免使用 CSS 表达式，因为 CSS 表达式会频繁的进行计算。

## 第八章(使用外部 JavaScript 和 CSS)
1. 在内联文件和外部加载文件的对比中，内联的加载速度要比外部加载要快，因为减少了 HTTP 请求。
2. 正常情况下，HTTP 请求会被浏览器缓存起来，而内联并不会缓存 JavaScript 文件和 CSS 文件。
3. 如果你的网站能够为用户带来完整的缓存率，则使用外部文件的收益大。如果不大可能产生完整缓存，则内联是更好的选择。
4. 如果网站中很多地方使用了相同的 JavaScript 和 CSS，使用外部文件可以提高这些文件的重用率，因为外部文件能够被缓存，再次使用时不用重新下载。
5. 在主页中，某些情况下，可能不需要缓存，如果只是作为一个跳转，则内联文件收益率更高。
6. 可以先使用内联的文件，然后等页面加载完之后 (onload) ，再设置定时器下载外部的文件。由于 JavaScript 和 CSS 被加载了两次，必须注意，JavaScript 可以定义函数但是不能马上执行。 CSS 使用了相对单位执行两次可能会产生问题。
7. 可以动态的设置 Cookie 决定是否下载外部脚本，如果首次加载，则下载外部文件并设置 Cookie，当下一次发现有 Cookie 的时候，则不再下载。

## 第九章(减少 DNS 查找)
1. 浏览器是通过 DNS 查找服务器的。正常来说，用户输入域名，然后浏览器根据域名去找 IP 地址。
2. 当访问了一个网站后，浏览器就会缓存该网站的 DNS 信息，那么下次请求就不会进行过多的 DNS 查找了。
3. 浏览器对缓存的 DNS 记录也有限制，而不管缓存的时间。如果用户访问了具有不同域名的网站，那么较早的 DNS 记录将被丢弃，必须重新查找该域名。不过，即便浏览器丢弃了 DNS 记录，操作系统可能依然保留着记录，因而无需通过发送请求来发送查询，从而避免了明显的延迟。
4. windows 上的 DNS 缓存由 DNS Client 服务进行管理。可以通过 ipconfig 命令来查看和刷新 DNS 服务：

```shell
ipconfig / displaydns
ipconfig / flushdns
```

5. 重新启动也会清空 DNS Client 服务缓存。
6. DNS 查找的数量与 Web 页面中唯一主机名相等，包括：样式表、脚本、图片、页面 Url等。减少主机名意味着可以减少 DNS 查找，但是同样降低了浏览器并行下载的个数，一般一个域名可以并行下载 2 个文件。所以具体情况可以具体分析。